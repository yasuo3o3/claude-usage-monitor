## 実装依頼：Claude Usage Monitor 色判定ロジックの改善

### 対象プロジェクト
Chrome拡張機能。修正対象は `background.js` と `popup.js` の2ファイル。

---

### 背景と問題点
現在の色判定は実際の利用率の固定閾値のみで判定しており、時間経過を考慮していない。
- 残り15分で利用率90%（余裕あり）でも黄色警告が出る
- 開始1時間で利用率60%（危険）でも緑のまま

---

### 新しい判定ロジック

#### 共通概念：ペース比率
```
ペース比率 = 利用率（utilization） ÷ 時間経過割合
```
時間経過割合は `popup.js` の `calculateExpectedUtilization()` が返す値（0〜100）を100で割ったもの。

---

#### 5時間リミット（five_hour）

| 条件 | バッジ・プログレスバー |
|------|----------------------|
| 利用率 < 60% | バッジ非表示・バー緑 |
| 利用率 ≥ 60% かつ ペース比率 ≤ 1.0 | 黄色 |
| 利用率 ≥ 60% かつ ペース比率 > 1.0 | 赤 |

---

#### 7日間リミット（seven_day / seven_day_sonnet / seven_day_opus）

| 条件 | バッジ・プログレスバー |
|------|----------------------|
| ペース比率 ≤ 0.8 | バッジ非表示・バー緑 |
| ペース比率 0.8〜1.0 | 黄色 |
| ペース比率 > 1.0 | 赤 |

---

#### エラー・未ログイン時
- 現在：赤（`#FF0000`）の `!`
- 変更後：グレー（`#888888`）の `!`

---

### フォールバック
`calculateExpectedUtilization()` が `null` を返す場合（リセット済み・開始直後等）は、従来の絶対値閾値で判定する：
- 5時間：利用率90%以上で黄色、100%以上で赤
- 7日間：利用率80%以上で黄色、100%以上で赤

---

### 修正箇所

**`background.js`**
- `updateBadgeFromUtilization(usage)` 内の色判定
- `getColorForUtilization()` を新ロジックに置き換え
- エラー時の `updateBadge('!', '#FF0000')` → `updateBadge('!', '#888888')`
- ※バッジの交互表示（H/W・15秒ごと）の仕組みは維持すること
- ※`background.js` は Service Worker のため `calculateExpectedUtilization()` が使えない。時間経過割合は `usage.five_hour.resets_at` と現在時刻から自前で計算すること（`popup.js` の同関数と同じロジック）

**`popup.js`**
- `updateProgressBar()` 内の色判定（L153〜163付近）
- `calculateExpectedUtilization(resetsAt, totalWindowHours)` の戻り値を色判定に活用する
- `resetsAt` と `totalWindowHours` は既に引数として渡されているので追加不要
